name: CI/CD

on:
  push:
    branches:
      - main
      - staging
  pull_request:
    branches:
      - main
      - staging

jobs:
  build-test:
    runs-on: ubuntu-latest
    env:
      CI: true
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Use Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            mobile/package.json

      - name: Cache backend node modules
        id: backend-cache
        uses: actions/cache@v3
        with:
          path: backend/node_modules
          key: ${{ runner.os }}-backend-${{ hashFiles('backend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-backend-

      - name: Install backend dependencies
        if: steps.backend-cache.outputs.cache-hit != 'true'
        run: npm install
        working-directory: backend

      - name: Cache mobile node modules
        id: mobile-cache
        uses: actions/cache@v3
        with:
          path: mobile/node_modules
          key: ${{ runner.os }}-mobile-${{ hashFiles('mobile/package.json') }}
          restore-keys: |
            ${{ runner.os }}-mobile-

      - name: Install mobile dependencies
        if: steps.mobile-cache.outputs.cache-hit != 'true'
        run: npm install
        working-directory: mobile

      - name: Run backend e2e test suite
        run: |
          mkdir -p test-results
          touch test-results/jest-results.json
          npm run test:e2e -- --runInBand --ci --json --outputFile=test-results/jest-results.json
        working-directory: backend

      - name: Upload backend test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results
          path: backend/test-results/jest-results.json

      - name: Run Expo doctor
        run: npx expo doctor --fix-dependencies
        working-directory: mobile

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Build Expo preview (Android)
        env:
          EAS_TOKEN: ${{ secrets.EAS_TOKEN }}
        run: |
          mkdir -p artifacts
          touch artifacts/eas-build-result.json
          cd mobile
          eas build --profile preview --platform android --non-interactive --json > ../artifacts/eas-build-result.json

      - name: Upload Expo build information
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: expo-build-preview
          path: artifacts/eas-build-result.json

      - name: Generate Swagger documentation
        run: |
          cd backend
          mkdir -p ../artifacts
          node - <<'NODE'
          require('ts-node/register');
          const { Test } = require('@nestjs/testing');
          const { DocumentBuilder, SwaggerModule } = require('@nestjs/swagger');
          const { writeFileSync, mkdirSync } = require('fs');
          const { AppModule } = require('./src/app.module');
          const { PrismaService } = require('./src/prisma/prisma.service');

          const prismaMock = new Proxy(
            {
              $connect: async () => {},
              $disconnect: async () => {},
              $on: () => {},
              enableShutdownHooks: async () => {},
            },
            {
              get(target, prop) {
                if (prop in target) {
                  return target[prop];
                }
                return async () => undefined;
              },
            },
          );

          async function generate() {
            const moduleRef = await Test.createTestingModule({ imports: [AppModule] })
              .overrideProvider(PrismaService)
              .useValue(prismaMock)
              .compile();

            const app = moduleRef.createNestApplication();
            await app.init();

            const config = new DocumentBuilder()
              .setTitle('HandyConnect API')
              .setDescription('API documentation for HandyConnect')
              .setVersion('1.0')
              .addBearerAuth()
              .build();

            const document = SwaggerModule.createDocument(app, config);
            mkdirSync('../artifacts', { recursive: true });
            writeFileSync('../artifacts/swagger.json', JSON.stringify(document, null, 2));

            await app.close();
          }

          generate().catch((error) => {
            console.error(error);
            process.exit(1);
          });
          NODE

      - name: Upload Swagger documentation artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: swagger-documentation
          path: artifacts/swagger.json

  deploy:
    needs: build-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/main'
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Use Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Cache backend node modules
        id: deploy-backend-cache
        uses: actions/cache@v3
        with:
          path: backend/node_modules
          key: ${{ runner.os }}-deploy-backend-${{ hashFiles('backend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-deploy-backend-

      - name: Install backend dependencies
        if: steps.deploy-backend-cache.outputs.cache-hit != 'true'
        run: npm install
        working-directory: backend

      - name: Download Swagger documentation
        uses: actions/download-artifact@v4
        with:
          name: swagger-documentation
          path: artifacts

      - name: Trigger Render deploy (staging)
        if: github.ref == 'refs/heads/staging'
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_STAGING_SERVICE_ID }}
        run: |
          curl -X POST https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"clearCache":false}'

      - name: Trigger Render deploy (production)
        if: github.ref == 'refs/heads/main'
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_PRODUCTION_SERVICE_ID }}
        run: |
          curl -X POST https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"clearCache":false}'

      - name: Run database seed (staging)
        if: github.ref == 'refs/heads/staging'
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
        run: npm run seed
        working-directory: backend

      - name: Run database seed (production)
        if: github.ref == 'refs/heads/main'
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
        run: npm run seed
        working-directory: backend

      - name: Upload Swagger docs to S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
          SWAGGER_BUCKET_NAME: ${{ secrets.SWAGGER_BUCKET_NAME }}
        run: |
          aws s3 cp artifacts/swagger.json s3://$SWAGGER_BUCKET_NAME/${{ github.ref_name }}-swagger.json --cache-control max-age=300

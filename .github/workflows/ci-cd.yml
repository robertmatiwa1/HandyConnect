name: HandyConnect CI/CD

on:
  push:
    branches: [ main, staging ]
  pull_request:
    branches: [ main, staging ]

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    env:
      CI: true

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Setup Node 18
      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3. Restore backend cache
      - name: Restore backend cache
        uses: actions/cache@v4
        with:
          path: backend/node_modules
          key: Linux-backend-${{ hashFiles('backend/package-lock.json') }}
          restore-keys: |
            Linux-backend-

      # 4. Install backend dependencies
      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      # 5. Run backend e2e tests
      - name: Run backend e2e test suite
        working-directory: backend
        run: |
          mkdir -p test-results
          npm run test:e2e -- --runInBand --ci --json --outputFile=test-results/jest-results.json

      - name: Upload backend test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results
          path: backend/test-results/jest-results.json

      # 6. Restore mobile cache
      - name: Restore mobile cache
        uses: actions/cache@v4
        with:
          path: mobile/node_modules
          key: Linux-mobile-${{ hashFiles('mobile/package-lock.json') }}
          restore-keys: |
            Linux-mobile-

      # 7. Install mobile dependencies
      - name: Install mobile dependencies
        working-directory: mobile
        run: npm ci

      # 8. Ensure Expo assets
      - name: Ensure Expo assets
        working-directory: mobile
        run: npm run ensure:assets

      # 9. Run Expo doctor
      - name: Run Expo doctor
        working-directory: mobile
        run: npx expo-doctor

      # 10. Install EAS CLI
      - name: Install EAS CLI
        run: npm install -g eas-cli

      # 11. Debug EAS/EXPO token presence
      - name: Debug EAS/EXPO token presence
        env:
          EAS_TOKEN: ${{ secrets.EAS_TOKEN }}
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          if [ -n "$EAS_TOKEN" ]; then
            echo "EAS_TOKEN is set (masked)."
          else
            echo "EAS_TOKEN is NOT set."
          fi
          if [ -n "$EXPO_TOKEN" ]; then
            echo "EXPO_TOKEN is set (masked)."
          else
            echo "EXPO_TOKEN is NOT set."
          fi
          npx eas whoami || echo "Not logged in to EAS CLI"

      # 12. Build Expo preview (Android)
      - name: Build Expo preview (Android)
        working-directory: mobile
        env:
          EAS_TOKEN: ${{ secrets.EAS_TOKEN }}
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          if [ -z "$EAS_TOKEN" ] && [ -z "$EXPO_TOKEN" ]; then
            echo "Error: neither EAS_TOKEN nor EXPO_TOKEN is available in the environment. Ensure the secret is configured in repo settings and that this run is not from a fork."
            exit 1
          fi
          mkdir -p ../artifacts
          eas build --profile preview --platform android --non-interactive --json > ../artifacts/eas-build-result.json

      - name: Upload Expo build info
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: expo-build-preview
          path: artifacts/eas-build-result.json

      # 13. Generate Swagger documentation
      - name: Generate Swagger documentation
        run: |
          cd backend
          mkdir -p ../artifacts
          node - <<'NODE'
          import { mkdirSync, writeFileSync } from 'fs';
          import { Test } from '@nestjs/testing';
          import { DocumentBuilder, SwaggerModule } from '@nestjs/swagger';
          import { AppModule } from './src/app.module.js';
          import { PrismaService } from './src/prisma/prisma.service.js';
          const prismaMock = new Proxy(
            { $connect: async()=>{}, $disconnect:async()=>{}, $on:()=>{}, enableShutdownHooks:async()=>{} },
            { get:(t,p)=>p in t?t[p]:async()=>undefined }
          );
          const generate = async()=>{
            const moduleRef=await Test.createTestingModule({imports:[AppModule]})
              .overrideProvider(PrismaService).useValue(prismaMock).compile();
            const app=moduleRef.createNestApplication(); await app.init();
            const config=new DocumentBuilder().setTitle('HandyConnect API')
              .setDescription('API documentation for HandyConnect')
              .setVersion('1.0').addBearerAuth().build();
            const document=SwaggerModule.createDocument(app,config);
            mkdirSync('../artifacts',{recursive:true});
            writeFileSync('../artifacts/swagger.json',JSON.stringify(document,null,2));
            await app.close();
          };
          generate().catch(e=>{console.error(e);process.exit(1);});
          NODE

      - name: Upload Swagger documentation artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: swagger-documentation
          path: artifacts/swagger.json

      # 14. Deploy to Render (staging or production)
      - name: Deploy to Render
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging'
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ github.ref == 'refs/heads/main' && secrets.RENDER_PRODUCTION_SERVICE_ID || secrets.RENDER_STAGING_SERVICE_ID }}
        run: |
          curl -X POST https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"clearCache":false}'

      # 15. Run database seed
      - name: Run database seed
        working-directory: backend
        env:
          DATABASE_URL: ${{ github.ref == 'refs/heads/main' && secrets.PRODUCTION_DATABASE_URL || secrets.STAGING_DATABASE_URL }}
        run: npm run seed

      # 16. Upload Swagger docs to S3
      - name: Upload Swagger docs to S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
          SWAGGER_BUCKET_NAME: ${{ secrets.SWAGGER_BUCKET_NAME }}
        run: |
          aws s3 cp artifacts/swagger.json s3://$SWAGGER_BUCKET_NAME/${{ github.ref_name }}-swagger.json --cache-control max-age=300

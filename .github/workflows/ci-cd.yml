name: HandyConnect CI/CD

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main, staging]

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    env:
      CI: true

    steps:

      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Setup Node.js
      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3. Backend cache restore
      - name: Restore backend cache
        uses: actions/cache@v4
        with:
          path: backend/node_modules
          key: backend-${{ hashFiles('backend/package-lock.json') }}
          restore-keys: backend-

      # 4. Backend install
      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      # 5. Backend tests
      - name: Run backend e2e tests
        working-directory: backend
        run: |
          mkdir -p test-results
          npm run test:e2e -- --runInBand --ci --json --outputFile=test-results/jest-results.json

      - name: Upload backend test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-test-results
          path: backend/test-results/jest-results.json

      # 6. Mobile cache
      - name: Restore mobile cache
        uses: actions/cache@v4
        with:
          path: mobile/node_modules
          key: mobile-${{ hashFiles('mobile/package-lock.json') }}
          restore-keys: mobile-

      # 7. Install mobile dependencies
      - name: Install mobile dependencies
        working-directory: mobile
        run: npm ci

      # 8. Ensure Expo assets
      - name: Ensure Expo assets
        working-directory: mobile
        run: npm run ensure:assets

      # 9. Run Expo doctor
      - name: Run Expo doctor
        working-directory: mobile
        run: npx expo-doctor

      # 10. Install EAS CLI
      - name: Install EAS CLI
        run: npm install -g eas-cli

      # 11. Debug presence of secrets
      - name: Debug EAS Token
        env:
          EAS_TOKEN: ${{ secrets.EAS_TOKEN }}
        run: |
          if [ -n "$EAS_TOKEN" ]; then
            echo "EAS_TOKEN is set."
          else
            echo "EAS_TOKEN is NOT set."
          fi
          npx eas whoami || echo "Not logged in."

      # 12. Skip Expo build if no token
      - name: Skip Expo build (no EAS token)
        if: ${{ ! secrets.EAS_TOKEN }}
        run: echo "Skipping Expo build because EAS_TOKEN is missing."

      # 13. Build Expo Android (ONLY when token exists)
      - name: Build Expo Android
        if: ${{ secrets.EAS_TOKEN }}
        working-directory: mobile
        env:
          EAS_TOKEN: ${{ secrets.EAS_TOKEN }}
        run: |
          mkdir -p ../artifacts
          eas build --profile preview --platform android --non-interactive --json > ../artifacts/eas-build-result.json

      - name: Upload Expo build result
        if: ${{ secrets.EAS_TOKEN }}
        uses: actions/upload-artifact@v4
        with:
          name: expo-build-preview
          path: artifacts/eas-build-result.json
